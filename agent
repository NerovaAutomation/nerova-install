#!/usr/bin/env bash
set -euo pipefail

MANIFEST_URL=${NEROVA_MANIFEST_URL:-"https://raw.githubusercontent.com/NerovaAutomation/nerova-install/main/manifest.json"}
INSTALL_ROOT=${NEROVA_HOME:-"$HOME/.nerovaagent"}
BIN_DIR=${NEROVA_BIN:-"$HOME/.local/bin"}
TMP_DIR=$(mktemp -d)
TRAP_ERR=1

cleanup() {
  local status=$?
  if [[ $TRAP_ERR -ne 0 && -d "$INSTALL_ROOT/frontend" ]]; then
    printf '\n[nerovaagent] Installation failed. Existing installation remains untouched.\n' >&2
  fi
  rm -rf "$TMP_DIR"
  exit $status
}
trap 'cleanup' EXIT

if ! command -v curl >/dev/null 2>&1; then
  echo "curl is required to install nerovaagent" >&2
  exit 1
fi

if ! command -v tar >/dev/null 2>&1; then
  echo "tar is required to install nerovaagent" >&2
  exit 1
fi

PYTHON=$(command -v python3 || command -v python || true)
if [[ -z "$PYTHON" ]]; then
  echo "python3 (or python) is required to parse the install manifest" >&2
  exit 1
fi

mkdir -p "$INSTALL_ROOT" "$BIN_DIR"

MANIFEST_JSON=$(curl -fsSL "$MANIFEST_URL")
if [[ -z "$MANIFEST_JSON" ]]; then
  echo "Failed to download install manifest" >&2
  exit 1
fi

VERSION=$(printf '%s' "$MANIFEST_JSON" | "$PYTHON" -c 'import json,sys; data=json.load(sys.stdin); print(data.get("version",""))')
ASSET_URL=$(printf '%s' "$MANIFEST_JSON" | "$PYTHON" -c 'import json,sys; data=json.load(sys.stdin); print(data.get("url",""))')
if [[ -z "$ASSET_URL" ]]; then
  echo "Manifest missing asset URL" >&2
  exit 1
fi

PKG_TGZ="$TMP_DIR/nerovaagent-frontend.tgz"
mkdir -p "$TMP_DIR/pkg"

echo "[nerovaagent] Downloading frontend package ${VERSION:-latest}"
curl -fsSL "$ASSET_URL" -o "$PKG_TGZ"

tar -xzf "$PKG_TGZ" -C "$TMP_DIR/pkg"
PKG_DIR="$TMP_DIR/pkg/package"
if [[ ! -d "$PKG_DIR" ]]; then
  echo "Unexpected package layout in archive" >&2
  exit 1
fi

TARGET_DIR="$INSTALL_ROOT/frontend"
rm -rf "$TARGET_DIR"
mkdir -p "$TARGET_DIR"
rsync -a "$PKG_DIR/" "$TARGET_DIR/"

pushd "$TARGET_DIR" >/dev/null
npm install --omit=dev
npx playwright install chromium
popd >/dev/null

ln -sf "$TARGET_DIR/bin/nerovaagent.js" "$BIN_DIR/nerovaagent"
chmod +x "$TARGET_DIR/bin/nerovaagent.js"

TRAP_ERR=0

cat <<MSG
[nerovaagent] Frontend CLI installed to $TARGET_DIR${VERSION:+ (version $VERSION)}
[nerovaagent] Symlink created at $BIN_DIR/nerovaagent
MSG
